<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Open Vote Network on Ethereum">
    <meta name="author" content="Paddy">
    <title>Live Feed</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

    <style> div { max-width: 600px; text-align: center;} </style>

  </head>

  <body>

    <div class="container">

      <h1 id="state"></h1>
      <div class="panel panel-primary">
         <div class="panel-heading">Colour codes.</div>
         <ul class="list-group">
             <li class="list-group-item list-group-item-success">Voter has voted.</li>
             <li class="list-group-item list-group-item-info">Voter has registered to vote. </li>
             <li class="list-group-item">Voter is eligible to vote.</li>
         </ul>
      </div>

      <div class="panel panel-primary">
         <div class="panel-heading">Vote cast. </div>
         <ul id="voted" class="list-group"></ul>
      </div>
      <div class="panel panel-primary">
         <div class="panel-heading">Registered to vote. </div>
         <ul id="registered" class="list-group"></ul>
      </div>
      <div class="panel panel-primary">
         <div class="panel-heading">Eligible to vote. </div>
         <ul id="listaddresses" class="list-group"></ul>
      </div>
    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="web3.min.js"></script>
    <script src="bignumber.min.js"></script>

    <script>

    var web3;
    var password = "ilikelittlepaddy";
    if (typeof web3 !== 'undefined') {
      web3 = new Web3(web3.currentProvider);
    } else {
      // set the provider you want from Web3.providers
      web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
    }

    var abi = [{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"eligible","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"xG","type":"uint256[2]"},{"name":"vG","type":"uint256[3]"},{"name":"r","type":"uint256"}],"name":"register","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[],"name":"computeTally","outputs":[{"name":"","type":"uint256[2]"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"addressid","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"w","type":"uint256"},{"name":"r1","type":"uint256"},{"name":"d1","type":"uint256"},{"name":"x","type":"uint256"}],"name":"create1outof2ZKPYesVote","outputs":[{"name":"res","type":"uint256[10]"},{"name":"res2","type":"uint256[4]"}],"type":"function"},{"constant":false,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"uint256"}],"name":"submod","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"question","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address[]"}],"name":"setEligible","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"counter","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"finishRegistrationPhase","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"params","type":"uint256[4]"},{"name":"y","type":"uint256[2]"},{"name":"a1","type":"uint256[2]"},{"name":"b1","type":"uint256[2]"},{"name":"a2","type":"uint256[2]"},{"name":"b2","type":"uint256[2]"}],"name":"submitVote","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"w","type":"uint256"},{"name":"r2","type":"uint256"},{"name":"d2","type":"uint256"},{"name":"x","type":"uint256"}],"name":"create1outof2ZKPNoVote","outputs":[{"name":"res","type":"uint256[10]"},{"name":"res2","type":"uint256[4]"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"votecast","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"params","type":"uint256[4]"},{"name":"y","type":"uint256[2]"},{"name":"a1","type":"uint256[2]"},{"name":"b1","type":"uint256[2]"},{"name":"a2","type":"uint256[2]"},{"name":"b2","type":"uint256[2]"}],"name":"verify1outof2ZKP","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"timer","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"x","type":"uint256"},{"name":"v","type":"uint256"},{"name":"xG","type":"uint256[2]"}],"name":"createZKP","outputs":[{"name":"res","type":"uint256[4]"}],"type":"function"},{"constant":false,"inputs":[],"name":"computeReconstructedPublicKeys","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"registered","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"state","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":false,"inputs":[{"name":"time","type":"uint256"},{"name":"_question","type":"string"}],"name":"beginSignUp","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"finaltally","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"reset","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"addresses","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"xG","type":"uint256[2]"},{"name":"r","type":"uint256"},{"name":"vG","type":"uint256[3]"}],"name":"verifyZKP","outputs":[{"name":"","type":"bool"}],"type":"function"},{"inputs":[],"type":"constructor"}];
    var anonymousvoting = web3.eth.contract(abi);
    var anonymousvotingAddr = anonymousvoting.at("0xa5a11cca1b0740a0b0221c7e059355ea572abb74");

    //TODO: Our program only allows up to 40 addresses.
    // Might be worth making that '40' a public variable...
    var totalNoAddresses = 40;
    var addresses = new Array();
    var eligible = {};
    var registered = {};
    var voted = {};
    var uponPageLoad = true;

    function currentState() {

      // If the page has just been loaded...
      // We need the list of eligible voters...
      if(uponPageLoad) {
          findEligible();
          findRegistered()
          findVoteCast();
          uponPageLoad = false;
      }

      var state = anonymousvotingAddr.state();

      // Currently in the SETUP Phase.
      if(state == 0) {
          document.getElementById("state").innerHTML = "SETUP: Election Authority sets voters as eligible.";
          findEligible();
      } else if(state == 1) { // SIGNUP Phase.
          document.getElementById("state").innerHTML = "SIGNUP: Voters can sign up.";
          findRegistered()
      } else if(state == 2) {
          document.getElementById("state").innerHTML = "COMPUTE: Ethereum must compute each voter's special voting key. ";
      } else if(state == 3) {
          document.getElementById("state").innerHTML = "VOTE: Voters must cast their vote. ";
          findVoteCast();
      } else {
          var yes = anonymousvotingAddr.finaltally(0);
          var total = anonymousvotingAddr.finaltally(1);
          var no = total - yes;
          document.getElementById('state').innerHTML = "TALLY: Yes - " + yes + " No - " + no;
      }
    }

    function findRegistered() {
      // Check which voters have submited their voting key!
      for(var i=0; i<addresses.length; i++) {

         // Only check if they have not already registered
         if(!registered[addresses[i]]) {

           // Have they registered since we last checked?
           if(anonymousvotingAddr.registered(addresses[i])) {
               // Add to our HTML list
               var ul = document.getElementById("registered");
               var li = document.createElement("li");
               li.innerHTML = addresses[i];
               li.setAttribute("id", "registered-" + addresses[i]);
               li.setAttribute("class", "list-group-item ");
               ul.appendChild(li);

               registered[addresses[i]] = true;
               document.getElementById("eligible-" + addresses[i]).setAttribute("class", "list-group-item list-group-item-info");
           }
         }
      }
    }
    function findVoteCast() {
      for(var i=0; i<addresses.length; i++) {

         // Only check if the voter has not already voted
         if(!voted[addresses[i]]) {

              //Have they voted since we last checked?
              if(anonymousvotingAddr.votecast(addresses[i])) {
                voted[addresses[i]] = true;
                var ul = document.getElementById("voted");
                var li = document.createElement("li");
                li.innerHTML = addresses[i];
                li.setAttribute("id", "voted-" + addresses[i]);
                li.setAttribute("class", "list-group-item ");
                ul.appendChild(li);

                document.getElementById("eligible-" + addresses[i]).setAttribute("class", "list-group-item list-group-item-success");
                document.getElementById("registered-" + addresses[i]).setAttribute("class", "list-group-item list-group-item-success");
              }
         }
      }
    }
    function findEligible() {

        // Check if any new addresses have been set as eligible.
        for(var i=0; i<totalNoAddresses; i++) {
            var addr = anonymousvotingAddr.addresses(i) ;

            // Lets make sure this is a real address...
            if(addr != '0x') {

              // Have we seen this address before? (if so; it'll be recorded as eligible)
              if(eligible[addr] === undefined) {

                // Initialise our hashmaps, and store the address
                eligible[addr] = true;
                registered[addr] = false;
                voted[addr] = false;
                addresses.push(addr);

                // Add to our HTML list
                var ul = document.getElementById("listaddresses");
                var li = document.createElement("li");
                li.innerHTML = addr;
                li.setAttribute("id", "eligible-" + addr);
                li.setAttribute("class", "list-group-item ");
                ul.appendChild(li);
              }
            } else {
              break; // No point continuing
            }
        }
    }

    setInterval("currentState()", 5000);
    currentState();

    /*
     * Below code copied from http://stackoverflow.com/questions/3387427/remove-element-by-id
     * Provides a .remove() to make above code more readable.
     */
    Element.prototype.remove = function() {
       this.parentElement.removeChild(this);
    }

    NodeList.prototype.remove = HTMLCollection.prototype.remove = function() {
        for(var i = this.length - 1; i >= 0; i--) {
            if(this[i] && this[i].parentElement) {
                this[i].parentElement.removeChild(this[i]);
            }
        }
    }

  </script>
  </body>
</html>
