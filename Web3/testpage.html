<html>
<head>
  <title>JavaScript API</title>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js">

</head>

<body>

  <div class="header">
    <h3>Talking to Geth</h3>
  </div>
  <div>
     <input type='file' accept='text/plain' onchange='openFile(event)'>
     <button onclick="reset()">Kick-start election!</button>
     <button onclick="finishRegistrationPhase()">FinishRegistration</button>
     <button onclick="computePublicKeys()">Continue Computing 1</button>
     <button onclick="submitVotes()">Submit Voices</button>
     <button onclick="tally()">Tally</button>
     <button onclick="topupEther()">Top up Ether</button>
     <button onclick="estimateGas()">Estimate Gas for Operations</button>
     <button onclick="drawOperationGasTable()">Draw table for operation estimates</button>
  </div>
  <div id="tableresult">
  </div>
  <div id="tableresult_operations">
  </div>
  <div id="infodiv">

  </div>

</body>

<script src="web3.min.js"></script>
<script src="bignumber.min.js"></script>
<script src ="https://code.jquery.com/jquery-3.1.0.slim.min.js"></script>
<script type="text/javascript">

// borrowed from http://stackoverflow.com/questions/14895287/how-to-print-object-array-in-javascript
function print_r(printthis, returnoutput) {
    var output = '';

    if($.isArray(printthis) || typeof(printthis) == 'object') {
        for(var i in printthis) {
            output += i + ' : ' + print_r(printthis[i], true) + '\n';
        }
    }else {
        output += printthis;
    }
    if(returnoutput && returnoutput == true) {
        return output;
    }else {
        append(output);
    }
}

function append(extra) {
    var div = document.getElementById('infodiv');
    div.innerHTML = div.innerHTML + "<br>" + "<p>" + extra + "</p>";
}

var web3;
var password = "ilikelittlepaddy";
if (typeof web3 !== 'undefined') {
  web3 = new Web3(web3.currentProvider);
} else {
  // set the provider you want from Web3.providers
  web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
}

var abi = [{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"eligible","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"xG","type":"uint256[2]"},{"name":"vG","type":"uint256[3]"},{"name":"r","type":"uint256"}],"name":"register","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[],"name":"computeTally","outputs":[{"name":"res","type":"uint256[2]"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"addressid","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"votecast","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"w","type":"uint256"},{"name":"i","type":"uint256"},{"name":"r1","type":"uint256"},{"name":"d1","type":"uint256"},{"name":"x","type":"uint256"}],"name":"create1outof2ZKPYesVote","outputs":[{"name":"res","type":"uint256[10]"},{"name":"res2","type":"uint256[4]"}],"type":"function"},{"constant":false,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"uint256"}],"name":"submod","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"question","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address[]"}],"name":"setEligible","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"name":"registeredkey","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"finishRegistrationPhase","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"params","type":"uint256[4]"},{"name":"y","type":"uint256[2]"},{"name":"a1","type":"uint256[2]"},{"name":"b1","type":"uint256[2]"},{"name":"a2","type":"uint256[2]"},{"name":"b2","type":"uint256[2]"}],"name":"submitVote","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"timer","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"x","type":"uint256"},{"name":"v","type":"uint256"},{"name":"xG","type":"uint256[2]"}],"name":"createZKP","outputs":[{"name":"res","type":"uint256[4]"}],"type":"function"},{"constant":false,"inputs":[],"name":"computeReconstructedPublicKeys","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"registered","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"name":"reconstructed","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"state","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":false,"inputs":[{"name":"params","type":"uint256[4]"},{"name":"i","type":"uint256"},{"name":"y","type":"uint256[2]"},{"name":"a1","type":"uint256[2]"},{"name":"b1","type":"uint256[2]"},{"name":"a2","type":"uint256[2]"},{"name":"b2","type":"uint256[2]"}],"name":"verify1outof2ZKP","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"time","type":"uint256"},{"name":"_question","type":"string"}],"name":"beginSignUp","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"},{"name":"","type":"uint256"}],"name":"votes","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"reset","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"w","type":"uint256"},{"name":"i","type":"uint256"},{"name":"r2","type":"uint256"},{"name":"d2","type":"uint256"},{"name":"x","type":"uint256"}],"name":"create1outof2ZKPNoVote","outputs":[{"name":"res","type":"uint256[10]"},{"name":"res2","type":"uint256[4]"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"addresses","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"xG","type":"uint256[2]"},{"name":"r","type":"uint256"},{"name":"vG","type":"uint256[3]"}],"name":"verifyZKP","outputs":[{"name":"","type":"bool"}],"type":"function"},{"inputs":[],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"address"}],"name":"Eligible","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"message","type":"string"},{"indexed":false,"name":"currentblock","type":"uint256"},{"indexed":false,"name":"futureblock","type":"uint256"}],"name":"StartTimer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"address"},{"indexed":false,"name":"res","type":"bool"},{"indexed":false,"name":"counter","type":"uint256"}],"name":"Registered","type":"event"},{"anonymous":false,"inputs":[],"name":"RegistrationFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"x","type":"uint256"},{"indexed":false,"name":"y","type":"uint256"},{"indexed":false,"name":"counter","type":"uint256"}],"name":"ReconstructedKey","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"address"},{"indexed":false,"name":"res","type":"bool"},{"indexed":false,"name":"counter","type":"uint256"}],"name":"RegisterVote","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"tally","type":"uint256"},{"indexed":false,"name":"counter","type":"uint256"}],"name":"Tally","type":"event"},{"anonymous":false,"inputs":[],"name":"Reset","type":"event"}];
var anonymousvoting = web3.eth.contract(abi);
var anonymousvotingAddr = anonymousvoting.at("0xe08fe699a872be8e1ad3d8fcd003de42e033ef8a");

// These are counters to ensure that enough people have finished
// the stage before moving on
var eligibleCounter = 0;
var registeredCounter = 0;
var submitedVoteLog = new Array();
var reconstructedCounter = 0;
var submitVoteCounter = 0;

// We keep track of the gas
// [0] = total
// [1] = lowest
// [2] = highest
// [3] = No transactions seen
function trackGas(record, gas) {

  var num = new BigNumber(gas);

  record[0] = record[0].plus(num);

  // Record the lowest
  if(num.lt(record[1])) {
    record[1] = num;
  }

  // Record the highest
  if(num.gt(record[2])) {
    record[2] = num;
  }

  // Increment
  record[3] = record[3].plus(new BigNumber('1'));
}

var eligibleGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var registerGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var computeGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var submitVoteGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var tallyGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];

var addMixedGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var mulGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var addMixedMGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var toAffineGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var addGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var isPubGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var isPubJGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
var isTwoAdditionGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];
// var isThreeAdditionGas = [new BigNumber('0'), new BigNumber('99999999'), new BigNumber('0'), new BigNumber('0')];

// Draw a table on the site to show us the cost for each stage.
function drawGasTable() {

  var eligibleTable = "<tr><td>Eligible</td><td>" + eligibleGas[1].toFormat(0) + "</td><td>" + eligibleGas[2].toFormat(0) + "</td><td>" + eligibleGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + eligibleGas[0].toFormat(0) + "</td></tr>";
  var registerTable = "<tr><td>Register to Vote</td><td>" + registerGas[1].toFormat(0) + "</td><td>" + registerGas[2].toFormat(0) + "</td><td>" + registerGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + registerGas[0].toFormat(0) + "</td></tr>";
  var computeTable = "<tr><td>Compute Keys</td><td>" + computeGas[1].toFormat(0) + "</td><td>" + computeGas[2].toFormat(0) + "</td><td>" + computeGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + computeGas[0].toFormat(0) + "</td></tr>";
  var submitVoteTable = "<tr><td>Submit Vote</td><td>" + submitVoteGas[1].toFormat(0) + "</td><td>" + submitVoteGas[2].toFormat(0) + "</td><td>" + submitVoteGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + submitVoteGas[0].toFormat(0) + "</td></tr>";
  var tallyTable = "<tr><td>Tally</td><td>" + tallyGas[1].toFormat(0) + "</td><td>" + tallyGas[2].toFormat(0) + "</td><td>" + tallyGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + tallyGas[0].toFormat(0) + "</td></tr>";
  var table = "<table> <tr><th>Stage</th><th>Lowest Gas</th><th>Highest Gas</th><th>Average Gas</th><th>Total Gas</th></tr>" +
              eligibleTable + registerTable + computeTable + submitVoteTable + tallyTable + "</table>";
  document.getElementById('tableresult').innerHTML = table;
}

function drawOperationGasTable() {
  var addMixedMRow = "<tr><td>Add Mixed M (Jacob, affine)</td><td>" + addMixedMGas[1].toFormat(0) + "</td><td>" + addMixedMGas[2].toFormat(0) + "</td><td>" + addMixedMGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + addMixedMGas[0].toFormat(0) + "</td><td>" + addMixedMGas[3] + "</td></tr>";
  var addMixedRow = "<tr><td>Add Mixed (Jacob, affine)</td><td>" + addMixedGas[1].toFormat(0) + "</td><td>" + addMixedGas[2].toFormat(0) + "</td><td>" + addMixedGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + addMixedGas[0].toFormat(0) + "</td><td>" + addMixedGas[3] + "</td></tr>";
  var addRow = "<tr><td>Add (Jacob)</td><td>" + addGas[1].toFormat(0) + "</td><td>" + addGas[2].toFormat(0) + "</td><td>" + addGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + addGas[0].toFormat(0) + "</td><td> " + addGas[3].toFormat(0) + "</td></tr>";
  var add2Row = "<tr><td>Two Addition (Jacob)</td><td>" + isTwoAdditionGas[1].toFormat(0) + "</td><td>" + isTwoAdditionGas[2].toFormat(0) + "</td><td>" + isTwoAdditionGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + isTwoAdditionGas[0].toFormat(0) + "</td><td> " + isTwoAdditionGas[3]+ "</td></tr>";
  // var add3Row = "<tr><td>Tree Addition (Jacob)</td><td>" + isThreeAdditionGas[1].toFormat(0) + "</td><td>" + isThreeAdditionGas[2].toFormat(0) + "</td><td>" + isThreeAdditionGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + isThreeAdditionGas[0].toFormat(0) + "</td><td> " + isThreeAdditionGas[3]+ "</td></tr>";
  var mulRow = "<tr><td>Mul</td><td>" + mulGas[1].toFormat(0) + "</td><td>" + mulGas[2].toFormat(0) + "</td><td>" + mulGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + mulGas[0].toFormat(0) + "</td><td>" + mulGas[3] + "</td></tr>";
  var toAffineRow = "<tr><td>Convert Jacob to Affine</td><td>" + toAffineGas[1].toFormat(0) + "</td><td>" + toAffineGas[2].toFormat(0) + "</td><td>" + toAffineGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + toAffineGas[0].toFormat(0) + "</td><td>" + toAffineGas[3] + "</td></tr>";
  var isPubRow = "<tr><td>Check if Public Key (Affine)</td><td>" + isPubGas[1].toFormat(0) + "</td><td>" + isPubGas[2].toFormat(0) + "</td><td>" + isPubGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + isPubGas[0].toFormat(0) +  "</td><td>" + isPubGas[3] + "</td></tr>";
  var isPubJRow = "<tr><td>Check if Public Key (Jacob)</td><td>" + isPubJGas[1].toFormat(0) + "</td><td>" + isPubJGas[2].toFormat(0) + "</td><td>" + isPubJGas[0].dividedBy(people.length).toFormat(0) + "</td><td>" + isPubJGas[0].toFormat(0) + "</td><td>" + isPubJGas[3] + "</td></tr>";
  var table = "<table> <tr><th>Stage</th><th>Lowest Gas</th><th>Highest Gas</th><th>Average Gas</th><th>Total Gas</th><th>Counter</th></tr>" +
              addRow + mulRow + addMixedRow + addMixedMRow + add2Row + toAffineRow + isPubRow + isPubJRow + "</table>";
  document.getElementById('tableresult_operations').innerHTML = table;
}
// var printStrEvt = anonymousvotingAddr.TestEvent({}, '', function(error, result){
//   if (!error){
//     print_r("Response: " + result);
//     append(result.event);
//     append(result.args.message + "," + result.args.c);
//   }
// });

/*
 * Catch events in real-time and update the site with the voting progress..
 */
var allevents = anonymousvotingAddr.allEvents({}, '', function(error, result){
  if (!error){

    // append("All - " + result.event);

    if(result.event === "Eligible") {
      var receipt = web3.eth.getTransactionReceipt(result.transactionHash);
      append(result.event + "," + result.args.addr + "," + eligibleCounter + "," + people.length + ", Gas Cost: " + receipt.gasUsed);

      eligibleCounter = eligibleCounter + 1;

      if(eligibleCounter == people.length) {
        trackGas(eligibleGas, receipt.gasUsed);
        allowSignUp();
      }
    }

    if(result.event === "ElectionAuthority") {
      append(result.event + "," + result.args.addr);
    }

    if(result.event === "StartTimer") {
       append(result.event + "," + result.args.message + "," + result.args.currentblock + "," + result.args.futureblock);

       register();
    }

    if(result.event === "RegistrationFinished") {
      append(result.event);
      computePublicKeys();
    }

    if(result.event === "Registered") {

        // We need to know the index for each person...
        // We can use this later on to store reconstructed keys
        for(var i=0; i<people.length; i++) {
              if(people[i][8] === result.args.addr) {
                   people[i][9] = result.args.counter; // Persons index in this election
                   var receipt = web3.eth.getTransactionReceipt(result.transactionHash);
                   append(result.event + "," + result.args.addr + "," + result.args.res + "," + people[i][6] + " -> " + result.args.counter + ", Gas Cost: " + receipt.gasUsed);
                  //  append(people[i][6] + " -> " + people[i][9]);

                  trackGas(registerGas, receipt.gasUsed);
               }
         }

         registeredCounter = registeredCounter + 1;

         // Once everyone has registered, recompue public keys!
         if(registeredCounter == people.length) {
           finishRegistrationPhase();
         }

    }

    if(result.event === "ReconstructedKey") {
         var receipt = web3.eth.getTransactionReceipt(result.transactionHash);
         append(result.event + "," + result.args.x.toString(10) + "," + result.args.y.toString(10) + "," + result.args.counter + ", Gas Cost: " + receipt.gasUsed);
         reconstructedCounter = reconstructedCounter + 1;

         for(var i=0; i<people.length; i++) {
           if(people[i][9].equals(result.args.counter)) {
             people[i][10] = [result.args.x,result.args.y];
             append("Found " + people[i][6] + "," + result.args.counter + " reconstructed public key");
           }
         }

         // Once we know everyones recomputed public key. We can submit votes.
         if(reconstructedCounter == people.length) {
              trackGas(computeGas, receipt.gasUsed);
              submitVotes();
         }
    }

    if(result.event === "RegisterVote") {

         // For some reason; I get duplicate events
         // This might be due to orphan blocks?
         //
         var f = false;
         for(var i=0; i<submitedVoteLog.length; i++) {
           if(submitedVoteLog[i] == result.args.addr) {
             f = true;
           }
         }

         if(!f) {
           submitVoteCounter = submitVoteCounter + 1;
           var receipt = web3.eth.getTransactionReceipt(result.transactionHash);
           append(result.event + "," + result.args.addr + "," + result.args.res + "," + result.args.counter + ", Gas Cost: " + receipt.gasUsed);
           submitedVoteLog.push(result.args.addr);
           trackGas(submitVoteGas, receipt.gasUsed);
         }

         if(submitVoteCounter == people.length) {
            tally();
         }
    }

    // Final tally... tell us gas usage as well.
    if(result.event === "Tally") {
      var receipt = web3.eth.getTransactionReceipt(result.transactionHash);
      append(result.event + " - Yes Votes: " + result.args.tally.toString(10) + " and Total Votes Counted: " + result.args.counter.toString(10) + ", Gas Cost: " + receipt.gasUsed);
      trackGas(tallyGas, receipt.gasUsed);
      drawGasTable();
      // reset();
    }

    if(result.event === "Reset") {
      append("Ready to start another election!");
      setEligible();
      // append(result.event + ",(" + result.args.x.toString(10) + "," + result.args.y.toString(10) + ")," + result.args.c);
    }

    if(result.event === "Debug") {

        var receipt = web3.eth.getTransactionReceipt(result.transactionHash);

        // Addition (mixed)
        if(result.args.op == 0) {
          trackGas(addMixedGas, result.args.gas);
          append("Addition Mixed Gas: " + result.args.gas);
        }

        //Addition (Mixed, and store in variable)
        if(result.args.op == 1) {
          trackGas(addMixedMGas, result.args.gas);
          append("Add Mixed (M) Gas: " + result.args.gas);
        }

        if(result.args.op == 2) {
          trackGas(mulGas, result.args.gas);
          append("Multiplication Gas: " + result.args.gas);
          var G = [new BigNumber("0x79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798"), new BigNumber("0x483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8")];

          web3.personal.unlockAccount(web3.eth.accounts[0],password);

          // Lets take advantage of the Jacob points...
          var num1 = [result.args.x, result.args.y, result.args.z];

          append("Using the number.... " + "(" + num1[0] + "," + num1[1] + "," + num1[2] + ")");
          anonymousvotingAddr.addition.sendTransaction(num1, G, {from:web3.eth.accounts[0], gas: 4200000});
          anonymousvotingAddr.additionJacob.sendTransaction(num1, num1, {from:web3.eth.accounts[0], gas: 4200000});
          anonymousvotingAddr.toAffine.sendTransaction(num1, {from:web3.eth.accounts[0], gas: 4200000});
          anonymousvotingAddr.additionM.sendTransaction(num1, G, {from:web3.eth.accounts[0], gas: 4200000});
          anonymousvotingAddr.ispubJ.sendTransaction(num1, {from:web3.eth.accounts[0], gas: 4200000});
          anonymousvotingAddr.twoadditionJacob.sendTransaction(num1, num1, {from:web3.eth.accounts[0], gas: 4200000});
          // anonymousvotingAddr.threeadditionJacob.sendTransaction(num1, num1, {from:web3.eth.accounts[0], gas: 4200000});
        }

        if(result.args.op == 3) {
          trackGas(toAffineGas, result.args.gas);
          append("To Affine Co-ordinates Gas: " + result.args.gas);

          var num1 = [result.args.x, result.args.y];

          anonymousvotingAddr.ispub.sendTransaction(num1, {from:web3.eth.accounts[0], gas: 4200000});
        }

        if(result.args.op == 4) {
          trackGas(addGas, result.args.gas);
          append("Addition of Jacob Points: " + result.args.gas);
          append("Gas Before: " + result.args.y + " and Gas After: " + result.args.z);
        }

        if(result.args.op == 5) {
          trackGas(isPubGas, result.args.gas);
          append("Is Public Key (Affine) Gas: " + result.args.gas);
        }

        if(result.args.op == 6) {
          trackGas(isPubJGas, result.args.gas);
          append("Is Public Key (Jacob) Gas: " + result.args.gas);
        }

        if(result.args.op == 7) {
          trackGas(isTwoAdditionGas, result.args.gas);
          append("Two Addition Gas (Jacob): " + result.args.gas);
          append("Gas Before: " + result.args.y + " and Gas After: " + result.args.z);
        }

        // if(result.args.op == 8) {
        //   trackGas(isThreeAdditionGas, result.args.gas);
        //   append("Three Addition Gas (Jacob): " + result.args.gas);
        //   append("Gas Before: " + result.args.y + " and Gas After: " + result.args.z);
        // }
    }
  }
});

// We submit our ZKP
// We need to compute yG...
// We submit yes or no votes
// Finally tally
var people = new Array();
var patrick = new Array();
var feng = new Array();
var taha = new Array();
var sia = new Array();
var maryam = new Array();
var ehsan = new Array();

// var EC = require('elliptic').ec;

var openFile = function(event) {
  var input = event.target;

  var reader = new FileReader();
  reader.onload = function(){
    var text = reader.result.split("\n");


    for(var i=1; i<web3.eth.accounts.length; i++) {
      var row = text[i].split(",");
      var person = new Array();

      //[0] = x (private key)
      //[1] = xG (public key)
      //[2] = v (random nonce for zkp)
      //[3] = w (random nonce for 1outof2 zkp)
      //[4] = r (1 or 2, random nonce for 1outof2 zkp)
      //[5] = d (1 or 2, random nonce for 1outof2 zkp)
      //[6] = name
      //[7] = vote yes or no
      //[8] = address id
      //[9] = counter;
      //[10] = recomputed public key
      person[0] = new BigNumber(row[0]);
      person[1] = [new BigNumber(row[1]), new BigNumber(row[2])];
      person[2] = new BigNumber(row[3]);
      person[3] = new BigNumber(row[4]);
      person[4] = new BigNumber(row[5]);
      person[5] = new BigNumber(row[6]);
      person[6] = row[7];
      person[7] = row[8];
      person[8] = web3.eth.accounts[i];
      person[9] = -1; // Index in the vote - given to us later
      person[10] = -1; // We fetch this later using an event

      people.push(person);

      append(text[i]);
    }

    if(i > 0) {
      append("You can now start the election");
    } else {
      append("No one was found in the file...");
    }
  };
  reader.readAsText(input.files[0]);


};

function finishRegistrationPhase() {
  web3.personal.unlockAccount(web3.eth.accounts[0],password);
  var res = anonymousvotingAddr.finishRegistrationPhase.sendTransaction({from:web3.eth.accounts[0], gas: 4200000})
  append("Finished Registration sent from " + web3.eth.accounts[0]);

  append("Finished Registration TxID: " + res);
}

function topupEther() {
  for(var i=1; i<web3.eth.accounts.length; i++) {
    web3.personal.unlockAccount(web3.eth.accounts[0],password);
    web3.eth.sendTransaction({from:web3.eth.coinbase, to:web3.eth.accounts[i], value: web3.toWei(1, "ether")});
  }
}

function setEligible() {

  if(people.length > 0) {
    append("====== Establish which voters are eligible ======");
    var addresses = new Array();

    for(var i=0; i<web3.eth.accounts.length; i++) {
      var account = web3.eth.accounts[i];
      var balance = web3.eth.getBalance(web3.eth.accounts[i]);
      append("Key: " + web3.eth.accounts[i] + " Balance: " + balance.toString(10));

      addresses.push(web3.eth.accounts[i]);
    }

    var res = anonymousvotingAddr.setEligible.sendTransaction(addresses, {from:web3.eth.accounts[0], gas: 4200000})

    append("Eligible whitelist sent from " + web3.eth.accounts[0]);

    append("Eligible TxID: " + res);

  } else {
    append("Please read a file with the people's information first!");
  }

}

function allowSignUp() {
  web3.personal.unlockAccount(web3.eth.accounts[0],password);
  var res = anonymousvotingAddr.beginSignUp.sendTransaction(2, "Should Satoshi Nakamoto reveal his real identity?", {from:web3.eth.accounts[0], gas: 4200000});
  append("Allow signup sent from " + web3.eth.accounts[0]);

  append("Allow Sign Up TxID: " + res);
}

// Make sure there are as many ETH accounts with Ether as there is people in the election!
// One ETH account per voter!
function register() {
  append("====== Registering Voters ======");
  for(var i=0; i<people.length; i++) {
    var person = people[i];
    var zkp = anonymousvotingAddr.createZKP.call(person[0], person[2], person[1]);
    var vG = [zkp[1], zkp[2], zkp[3]];
    // var res = anonymousvotingAddr.register.call(person[1], vG, zkp[0]);
    web3.personal.unlockAccount(person[8],password);
    append("Registration for " + person[6] + " TxID: " + anonymousvotingAddr.register.sendTransaction(person[1], vG, zkp[0], {from:person[8], gas: 4200000}));
    // append("Can " + person[6] + " Register OK? " + res);
  }
}

function computePublicKeys() {
  append("====== Compute Reconstructed Public Keys ======");
  web3.personal.unlockAccount(web3.eth.accounts[0],password);
  var res = anonymousvotingAddr.computeReconstructedPublicKeys.sendTransaction({from:web3.eth.accounts[0], gas: 4200000});

  append("Compute public keys TxiD: " + res);
}

function submitVotes() {
  append("====== Submit Votes ======");
  append("Ready to submit votes");

  for(var i=0; i<people.length; i++) {
    var person = people[i];

    var w = person[3];
    var r = person[4];
    var d = person[5];
    var yG = person[10];
    var xG = person[1];
    var x = person[0];
    var result;

    if(person[7] == 1) {
      append(person[6] + " is voting yes");
      result = anonymousvotingAddr.create1outof2ZKPYesVote.call(w,person[9],r,d,x);
    } else {
      append(person[6] + " is voting no");
      result = anonymousvotingAddr.create1outof2ZKPNoVote.call(w,person[9],r,d,x);
    }

    var y = [result[0][0], result[0][1]];
    var a1 = [result[0][2], result[0][3]];
    var b1 = [result[0][4], result[0][5]];
    var a2 = [result[0][6], result[0][7]];
    var b2 = [result[0][8], result[0][9]];

    var params = [result[1][0], result[1][1], result[1][2], result[1][3]];
    result = anonymousvotingAddr.verify1outof2ZKP.call(params, person[9], y, a1, b1, a2, b2);
    append("Does the 1 out of 2 ZKP Verify for " + person[6] + " = " + result);
    // var result2 = anonymousvotingAddr.submitVote.call(params, y, a1, b1, a2, b2);
    // append("Does the 1 out of 2 ZKP Verify for " + person[6] + " = " + result);

    web3.personal.unlockAccount(person[8],password);
    result = anonymousvotingAddr.submitVote.sendTransaction(params, y, a1, b1, a2, b2, {from:person[8], gas: 4200000});

    append(person[6] + ": Submit vote... TxID is " + result);
  }
}

function tally() {
  append("====== Tally ======");

  web3.personal.unlockAccount(web3.eth.accounts[0],password);
  result = anonymousvotingAddr.computeTally.sendTransaction({from:web3.eth.accounts[0], gas: 4200000});

  append("TxID for tally: " + result);
}

function checkOwner() {
   append("==== Owner ===");
   append("Owner is " + anonymousvotingAddr.owner());
}

function reset() {
  append("=== Reset Election ===");
  web3.personal.unlockAccount(web3.eth.accounts[0],password);
  result = anonymousvotingAddr.reset.sendTransaction({from:web3.eth.accounts[0], gas: 4200000});
  eligibleCounter = 0;
  registeredCounter = 0;
  submitedVoteLog = new Array();
  reconstructedCounter = 0;
  submitVoteCounter = 0;
}


// These functions are to estimate the gas of individual functions
function estimateGas() {


  for(var i=0; i<people.length; i++) {
    var person = people[i];
    var G = [new BigNumber("0x79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798"), new BigNumber("0x483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8")];
    web3.personal.unlockAccount(web3.eth.accounts[0],password);
    anonymousvotingAddr.multiplication.sendTransaction(person[0], G, {from:web3.eth.accounts[0], gas: 4200000});

  }
}

</script>
</html>
