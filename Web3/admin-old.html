
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Open Vote Network on Ethereum">
    <meta name="author" content="Paddy">
    <title>Admin Page</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

    <link href="css/jquery.datetimepicker.css" rel="stylesheet">

  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Open Vote Network</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="vote.html">Vote</a></li>
            <li class="active"><a href="admin.html">Admin</a></li>
            <li><a href="livefeed.html" target="_blank">Live Feed</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <div class="jumbotron">
        <h2>Current Phase:</h2>
        <p id="state"></p>
        <p id="endby"></p>
        <h2>Question:</h2>
        <p id="question"></p>

        <div id="reset">
          <h4>Kill Switch - Reset Election</h4>
          <button onclick="reset()">Reset</button>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="thumbnail">
            <h4> 1. Unlock your Ethereum address </h4>
            <div id="dropdown">
            </div>
        </div>
        </div>
        <div class="col-md-4">
          <div class="thumbnail">
            <h4>2. Set voting whitelist</h4>
          <div id="eligible">
            <p>There are currently <span id="totaleligible">0</span> eligible voters. </p>
            <textarea id="addresses" name="list" cols="40" rows="5"></textarea> <br>
            <button onclick="setEligible()">Set as eligible</button>
            <p>p.s. seperate Ethereum accounts by a comma ","</p>
          </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="thumbnail">
            <h4>2. Begin Registration </h4>
            <div id="beginRegistration">
              <p id="minimumgap"> Minimum amount of time before a round can end
                <select id="minimum">
                  <!-- <option value="60">1 minute</option> -->
                  <option value="1800">30 minutes</option>
                  <option value="3600">1 hour</option>
                  <option value="10800">3 hours</option>
                  <option value="21600">6 hours</option>
                  <option value="43200">12 hours</option>
                  <option value="86400">1 day</option>
                  <option value="259200">3 days</option>
                  <option value="604800">7 days</option>
                </select>
              </p>
              <p id="datepairExample">
                  Registration phase can finish by...
                  <input id="datetimepickerfinishby" type="text">
              </p>
              <p id="endSignup">
                  Refund voters if registration does not end by...
                  <input id="datetimepickerendsignup" type="text">
              </p>
              <p id="endCompute">
                  Refund voters if computation does not end by...
                  <input id="datetimepickerendcompute" type="text">
              </p>
              <p id="endCommitment">
                  Refund voters if commitment does not end by...
                  <input id="datetimepickerendcommitment" type="text">
              </p>
              <p id="endVote">
                  Refund voters if voting does not end by...
                  <input id="datetimepickerendvote" type="text">
              </p>
              <p>What is the question? <input type='text' id='questioninput' value='Dummy Question?'/> </p>
              <p><input type="checkbox" id="commitmenttick" checked> Enable the 'Commitment' Phase?</p>
              <p id="beginRegistrationbutton"><button onclick="beginRegistration()">Begin Registration Phase</button></p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <div class="thumbnail">
            <h4>4. Finish Registration Phase</h4>
            <div id="finishRegistration">
                  <p id="currentRegistration"></p>
                  <p id="finishby"></p>
                  <button onclick="finishRegistration()">Finish Registration Phase</button>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="thumbnail">
            <h4>5. Compute all special keys?</h4>
            <div id="computekeys">
              <button onclick="computekeys()">Compute Keys</button>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="thumbnail">
            <h4>6. Compute Tally</h4>
            <div id="tally">
               <p id="commitmentstats"></p>
               <p id="totalvoted"></p>
               <button onclick="tally()">Get Tally</button>
            </div>
          </div>
        </div>
      </div>

    </div>
    <hr>

      <div id="txlist">
        <p>Transaction List:</p>
      </div>
      <div id="infodiv">
        <p>Events from Ethereum:</p>
      </div>
    </div><!-- /.container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="web3.min.js"></script>
    <script src="bignumber.min.js"></script>
    <script src="js/jquery.datetimepicker.js"></script>

<script>

// Controls which times and dates are displayed by default
// We need to ensure there is a 'minimum' gap between default times too.
// TODO: When the 'gap' drop down box is used... update all times accordingly.
function setInitialTimes() {

   // Initial time is set here.
   jQuery('#datetimepickerfinishby').datetimepicker(
     {minDate:'0', // Sets minimum date as today
      value:new Date()});

   var endsignuptime = new Date();
   var gap = new BigNumber($('#minimum').find(":selected").val());

   endsignuptime.setTime(endsignuptime.getTime() + (gap*1000));
   jQuery('#datetimepickerendsignup').datetimepicker(
     {minDate:'0', // Sets minimum date as today
      value:endsignuptime});

   var endcomputetime = new Date();
   endcomputetime.setTime(endsignuptime.getTime() + (gap*1000));
   jQuery('#datetimepickerendcompute').datetimepicker(
     {minDate:'0', // Sets minimum date as today
      value:endcomputetime});

   var endcommittime = new Date();
   endcommittime.setTime(endcomputetime.getTime() + (gap*1000));
   jQuery('#datetimepickerendcommitment').datetimepicker(
     {minDate:'0', // Sets minimum date as today
     value:endcommittime});

   var endvotetime = new Date();
   endvotetime.setTime(endcommittime.getTime() + (gap*1000));
   jQuery('#datetimepickerendvote').datetimepicker(
     {minDate:'0', // Sets minimum date as today
     value:endvotetime});


   $.datetimepicker.setLocale('en');

}

setInitialTimes();

// Relevant code that talks to Ethereum
var web3;
var password = "ilikelittlepaddy";
var addressChosen = false;
var addr = 0;
var state = 0;
var accountindex = 0;

if (typeof web3 !== 'undefined') {
  web3 = new Web3(web3.currentProvider);
} else {
  // set the provider you want from Web3.providers
  web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
}

var abi = [{"constant":true,"inputs":[],"name":"endComputationPhase","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"eligible","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"xG","type":"uint256[2]"},{"name":"vG","type":"uint256[3]"},{"name":"r","type":"uint256"}],"name":"register","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[],"name":"computeTally","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"addressid","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"totaleligible","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"getVoter","outputs":[{"name":"_registeredkey","type":"uint256[2]"},{"name":"_reconstructedkey","type":"uint256[2]"},{"name":"_commitment","type":"bytes32"}],"type":"function"},{"constant":true,"inputs":[],"name":"endSignupPhase","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"uint256"}],"name":"submod","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"commitmentphase","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"question","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address[]"}],"name":"setEligible","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"finishSignupPhase","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"h","type":"bytes32"}],"name":"submitCommitment","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"endCommitmentPhase","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"finishRegistrationPhase","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"params","type":"uint256[4]"},{"name":"y","type":"uint256[2]"},{"name":"a1","type":"uint256[2]"},{"name":"b1","type":"uint256[2]"},{"name":"a2","type":"uint256[2]"},{"name":"b2","type":"uint256[2]"}],"name":"submitVote","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"totalcommitted","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"votecast","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"totalvoted","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"params","type":"uint256[4]"},{"name":"y","type":"uint256[2]"},{"name":"a1","type":"uint256[2]"},{"name":"b1","type":"uint256[2]"},{"name":"a2","type":"uint256[2]"},{"name":"b2","type":"uint256[2]"}],"name":"verify1outof2ZKP","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[],"name":"computeReconstructedPublicKeys","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"endVotingPhase","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"commitment","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"registered","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"_question","type":"string"},{"name":"enableCommitmentPhase","type":"bool"},{"name":"_finishSignupPhase","type":"uint256"},{"name":"_endSignupPhase","type":"uint256"},{"name":"_endComputationPhase","type":"uint256"},{"name":"_endCommitmentPhase","type":"uint256"},{"name":"_endVotingPhase","type":"uint256"},{"name":"gap","type":"uint256"}],"name":"beginSignUp","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"state","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"finaltally","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"totalregistered","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"reset","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"voters","outputs":[{"name":"addr","type":"address"},{"name":"commitment","type":"bytes32"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"addresses","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"xG","type":"uint256[2]"},{"name":"r","type":"uint256"},{"name":"vG","type":"uint256[3]"}],"name":"verifyZKP","outputs":[{"name":"","type":"bool"}],"type":"function"},{"inputs":[],"type":"constructor"}];
var anonymousvoting = web3.eth.contract(abi);
var anonymousvotingAddr = anonymousvoting.at("0xff9df52a4a7a4ac06049b82d0cd180d1de29bce3");

var selectbox = "<p>Address:</p><select id='addrs'>";

var foundOwner = false;
// Let user select one of their Ethereum addresses
for(var i=0; i<web3.eth.accounts.length; i++) {

  if(anonymousvotingAddr.owner() == web3.eth.accounts[i]) {
    foundOwner = true;
    selectbox = selectbox + '<option value="' + i + '">' + web3.eth.accounts[i] + '</option>';
  }
}

selectbox = selectbox + "</select> <p>Password:</p> <input type='text' id='passwordf' value='ilikelittlepaddy' name='fname'><button onclick='unlock()'>Unlock</button>";

if(foundOwner) {
  document.getElementById('dropdown').innerHTML = selectbox;
} else {
  document.getElementById('dropdown').innerHTML = "You do not have an Ethereum account that is the Election Authority for this vote";
}

function unlock(callback) {
  var _addr = $('#addrs').find(":selected").text();
  var _password = document.getElementById('passwordf').value;

  if(web3.personal.unlockAccount(_addr,_password)) {
    addressChosen = true;
    addr = _addr;
    password = _password;
    accountindex = $( "#addrs" ).val();
    document.getElementById('dropdown').innerHTML = "You have selected the address " + addr;
  }
}
// Check that the user is eligible to vote
function setEligible() {
  var tempaddr;

  if(addressChosen) {

    var lastchar = document.getElementById('addresses').value.trim().slice(-1);
    var toSplit;

    // Make sure the user has not ended the list with ','
    if(lastchar == ',') {
      var len = document.getElementById('addresses').value.length;
      toSplit = document.getElementById('addresses').value.substring(0,len-1);

    } else {
      toSplit = document.getElementById('addresses').value;
    }

    var split = toSplit.split(",");

    // TODO: Sanity check the list ... verify they are all valid Ethereum addresses
    var addresses = new Array();

    // TODO: Check with Ethereum how many addresses have ALREADY been accepted.
    // It will only hold UP to 40. No point sending 40 if Ethereum already has 25. (We should send 15 in that case).
    var uptolimit;

    if(split.length > 40) {
      if(!confirm("We can only use the first 40 addresses... Is this ok?")) {
        return;
      }
      uptolimit = 40;
    } else {
      uptolimit = split.length;
    }

    // No point re-submiting an address if it is already eligible
    for(var i=0; i<uptolimit; i++) {
      if(!anonymousvotingAddr.eligible(split[i])) {
        addresses.push(split[i]);
      }
    }

    // Do we have any addresses that are not yet eligible?
    if(addresses.length > 0) {
      web3.personal.unlockAccount(addr,password)
      var res = anonymousvotingAddr.setEligible.sendTransaction(addresses, {from:web3.eth.accounts[accountindex], gas: 4200000})

      txlist("Set Eligible: " + res);

      alert("Sent " + addresses.length + " addresses to Ethereum whitelist");
    } else {
      alert("All addresses are already eligible!");
    }

  } else {
    alert("You need to select the admin address first!");
  }
}

// Try and fetch the re-computed key... required for tallying
function checkForReconstructedKey() {

  if(anonymousvotingAddr.reconstructed(addr) != 0) {
      computedKey = true;
      document.getElementById('reconstructed').innerHTML = "Reconstructed key found";
      index = anonymousvotingAddr.addressid(addr); // What is our index for the vote?

  } else {
      document.getElementById('foundreconstructedkey').innerHTML = "Reconstructed key NOT found";
  }
}

// Allow people to start submiting their voting key.
function beginRegistration() {

  if(!addressChosen) {
    alert("Please unlock your Ethereum address.");
    return;
  }

  if(state != 0) {
    alert("Please wait until SETUP Phase");
    return;
  }

  // Sanity check all the timer values given to us
  var finishby_val = $('#datetimepickerfinishby').datetimepicker('getValue');
  if(finishby_val == null) {
    alert("Please select the finish time for the Registration phase");
    return;
  }

  var endsignup_val = $('#datetimepickerendsignup').datetimepicker('getValue');

  if(endsignup_val == null) {
    alert("Please select which time the Registration phase MUST end before refunds are issued");
    return;
  }

  var endcompute_val = $('#datetimepickerendcompute').datetimepicker('getValue');

  if(endcompute_val == null) {
    alert("Please select which time the Computation phase MUST end before refunds are issued");
    return;
  }

  // Make sure the option is enabled (tick box is checked)
  var enableCommitment = $('#commitmenttick').is(":checked");
  var endcommitment_val = 0;

  // Only grab commitment value if that phase is enabled...
  if(enableCommitment) {

    endcommitment_val = $('#datetimepickerendcommitment').datetimepicker('getValue');

    if(endcommitment_val == null) {
      alert("Please select which time the Commitment phase MUST end before refunds are issued");
      return;
    }
  }

  var endvote_val = $('#datetimepickerendvote').datetimepicker('getValue');

  if(endvote_val == null) {
    alert("Please select which time the Computation phase MUST end before refunds are issued");
    return;
  }

  var finishby = Math.floor(finishby_val.getTime()/1000); // Ethereum works in seconds, not milliseconds.
  var endsignup = Math.floor(endsignup_val.getTime()/1000); // Ethereum works in seconds, not milliseconds.
  var endcompute = Math.floor(endcompute_val.getTime()/1000); // Ethereum works in seconds, not milliseconds.
  var endcommitment = 0;

  // Again we only store endcommitment if the phase is enabled
  if(enableCommitment) {
    endcommitment = Math.floor(endcommitment_val.getTime()/1000); // Ethereum works in seconds, not milliseconds.
  }

  var gap = new BigNumber($('#minimum').find(":selected").val());
  var endvote = Math.floor(endvote_val.getTime()/1000); // Ethereum works in seconds, not milliseconds.
  var question = document.getElementById('questioninput').value;

  web3.personal.unlockAccount(addr,password);

  if(anonymousvotingAddr.beginSignUp.call(question, enableCommitment, finishby, endsignup, endcompute, endcommitment, endvote, gap, {from:web3.eth.accounts[accountindex]})) {
     var res = anonymousvotingAddr.beginSignUp.sendTransaction(question, enableCommitment, finishby, endsignup, endcompute, endcommitment, endvote, gap, {from:web3.eth.accounts[accountindex], gas: 4200000});
     destorypickers();
     document.getElementById("beginRegistrationbutton").innerHTML  = "Waiting for Ethereum to confirm that Registration has started";
     txlist("Begin Registration Phase: " + res);
  } else {
     // TODO: Better error message, and perhaps JS to enforce minimum gap etc.
     alert("Ethereum will not accept those dates");
  }
}

function destorypickers() {
    $('#datetimepickerfinishby').datetimepicker('destroy');
    $('#datetimepickerendsignup').datetimepicker('destroy');
    $('#datetimepickerendcompute').datetimepicker('destroy');
    $('#datetimepickerendcommitment').datetimepicker('destroy');
    $('#datetimepickerendvote').datetimepicker('destroy');
}
// Allow the Election Authority to finish the registration phase...
function finishRegistration() {
  if(!addressChosen) {
    alert("Please unlock your Ethereum address");
    return;
  }

  if(state != 1) {
    alert("Please wait until Registration Phase");
    return;
  }

  web3.personal.unlockAccount(addr,password);
  var res = anonymousvotingAddr.finishRegistrationPhase.sendTransaction({from:web3.eth.accounts[accountindex], gas: 4200000});
  document.getElementById("finishRegistration").innerHTML  = "Waiting for Ethereum to confirm that Registration has finished";

  txlist("Finish Registration Phase: " + res);
}

// Tell inform to compute each voter's special key
function computekeys() {

    if(!addressChosen) {
      alert("Please unlock your Ethereum address");
      return;
    }

    if(state != 2) {
      alert("Please wait until COMPUTE Phase");
      return;
    }

    web3.personal.unlockAccount(web3.eth.accounts[accountindex],password);
    var res = anonymousvotingAddr.computeReconstructedPublicKeys.sendTransaction({from:web3.eth.accounts[accountindex], gas: 4200000});
    document.getElementById("computekeys").innerHTML = "Waiting for Ethereum to confirm that special keys have been computed";
    txlist("Computing Keys: " + res);

}

// Tell Ethereum to compute Tally
function tally() {

  // Ethereum Account needs to be unlocked.
  if(!addressChosen) {
    alert("Please unlock your Ethereum address");
    return;
  }

  // Make sure we are in the correct phase.
  if(state != 4) {
    alert("Please wait until VOTE Phase");
    return;
  }
  var reg = anonymousvotingAddr.totalregistered();
  var voted = anonymousvotingAddr.totalvoted();

  // Make sure everyone has voted!
  if(!reg.equals(voted)) {
     alert("Please wait for everyone to vote");
     return;
  }

  //TODO: Check that all votes have been cast..
  // Can do this by checking the public 'votecast' mapping...
  web3.personal.unlockAccount(web3.eth.accounts[accountindex],password);
  var res = anonymousvotingAddr.computeTally.sendTransaction({from:web3.eth.accounts[accountindex], gas: 4200000});
  document.getElementById("tally").innerHTML  = "Waiting for Ethereum to confirm tally";
  txlist("Compute Tally: " + res);
}

function reset() {
  web3.personal.unlockAccount(web3.eth.accounts[accountindex],password);
  var res = anonymousvotingAddr.reset.sendTransaction({from:web3.eth.accounts[accountindex], gas: 4200000});
    txlist("Reset: " + res);
}

// Update question set for vote.
function whatIsQuestion() {
  var q = anonymousvotingAddr.question();
  document.getElementById('question').innerHTML = q;
}

// Keep a list of transaction hashes on the website. Might be useful...
function txlist(extra) {
    document.getElementById('txlist').innerHTML = document.getElementById('txlist').innerHTML + "<br>" + extra;
}

// Responsible for updating the website's text depending on the election's current phase. (i.e. if we are in VOTE, no point enabling compute button).
function currentState() {
  state = anonymousvotingAddr.state();
  whatIsQuestion();

  if(state == 0) { // SETUP
    document.getElementById('state').innerHTML = "SETUP: You need to whitelist each voter's address";
    document.getElementById('endby').innerHTML = "No time limit for this phase";
  } else if(state == 1) {

    // Update the state, and finish time.
    document.getElementById('state').innerHTML = "SIGNUP: Voters need to register their voting codes";
    var date = new Date();
    date.setTime(anonymousvotingAddr.endSignupPhase() * 1000);
    document.getElementById('endby').innerHTML = "Phase must be finished before " + date;

    // Close options that can no longer be used.
    document.getElementById("eligible").innerHTML = "Can no longer set new Ethereum accounts as eligible ";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";

    // Statistics on number of registered voters, and when authority can transition to the next phase
    var finishby = document.getElementById('finishby');
    if(finishby != null) {
      var date = new Date();
      date.setTime(anonymousvotingAddr.finishSignupPhase() * 1000);
      document.getElementById('finishby').innerHTML = "You can finish the Registration phase after  " + date;
    }

    // Ensure pickers are destroyed
    destorypickers();

  } else if(state == 2) { // SIGNUP
    document.getElementById('state').innerHTML = "COMPUTE: You need to inform Ethereum to compute the voter's special keys";
    var date = new Date();
    date.setTime(anonymousvotingAddr.endComputationPhase() * 1000);
    document.getElementById('endby').innerHTML = "Phase must be finished before " + date;

    document.getElementById("eligible").innerHTML = "Can no longer Registration new addresses";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";
    document.getElementById('finishRegistration').innerHTML = "Registration phase has already finshed";

    // Ensure pickers are destroyed
    destorypickers();

  } else if(state == 3) { // COMMITMENT
    document.getElementById('state').innerHTML = "COMMIT: Voters need to send a commitment of their vote to Ethereum";
    var date = new Date();
    date.setTime(anonymousvotingAddr.endCommitmentPhase() * 1000);
    document.getElementById('endby').innerHTML = "Phase must be finished before " + date;

    document.getElementById("eligible").innerHTML = "Can no longer Registration new addresses";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";
    document.getElementById('finishRegistration').innerHTML = "Registration phase has already finshed";
    document.getElementById('computekeys').innerHTML = "Voters keys have already been computed";

    // Ensure pickers are destroyed
    destorypickers();

  } else if(state == 4) { // VOTE
    document.getElementById('state').innerHTML = "VOTE: Voters need to cast their vote";
    var date = new Date();
    date.setTime(anonymousvotingAddr.endVotingPhase() * 1000);
    document.getElementById('endby').innerHTML = "Phase must be finished before " + date;
    document.getElementById("eligible").innerHTML = "Can no longer Registration new addresses";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";
    document.getElementById('finishRegistration').innerHTML = "Registration phase has already finshed";
    document.getElementById('computekeys').innerHTML = "Voters keys have already been computed";

    // Ensure pickers are destroyed
    destorypickers();


  } else if(state == 5) { // TALLY
    var yes = anonymousvotingAddr.finaltally(0);
    var total = anonymousvotingAddr.finaltally(1);
    var no = total - yes;
    document.getElementById('state').innerHTML = "TALLY: Yes - " + yes + " No - " + no;
    document.getElementById('endby').innerHTML = "We are finished!";
    document.getElementById("eligible").innerHTML = "Can no longer Registration new addresses";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";
    document.getElementById('finishRegistration').innerHTML = "Registration phase has already finshed";
    document.getElementById('computekeys').innerHTML = "Voters keys have already been computed";
    document.getElementById('tally').innerHTML = "Tally has been computed!";

    // Ensure pickers are destroyed
    destorypickers();
  } else {
    document.getElementById('state').innerHTML = "Undocumented Phase...";
  }

  // Some statistics on the acitivty of voters.
  // i.e. how many eligible, registered, committed or voted.
  updateStatistics();
}

function updateStatistics() {

  // Only display in stage 0
  if(state < 1) {
    document.getElementById('totaleligible').innerHTML = anonymousvotingAddr.totaleligible();
  }

  // Only display in states 0,1
  if(state < 2) {
    if(document.getElementById('currentRegistration') != null) {
      document.getElementById('currentRegistration').innerHTML = "There is currently " + anonymousvotingAddr.totalregistered() + "/" + anonymousvotingAddr.totaleligible() + " registered voters";
    }
  }

  // Only display in states 1,2,3,4... No point in Tally Phase.
  if(state < 5) {
    // Remove mention of commitment phase if not enabled.
    if(!anonymousvotingAddr.commitmentphase()) {
      document.getElementById('commitmentstats').innerHTML = "";
    } else { // Otherwise tell us how many people have committed their vote!
      document.getElementById('commitmentstats').innerHTML = anonymousvotingAddr.totalcommitted() + "/" + anonymousvotingAddr.totalregistered() + " voters have committed (but not revealed) their vote";
    }

    document.getElementById('totalvoted').innerHTML = anonymousvotingAddr.totalvoted() + "/" + anonymousvotingAddr.totalregistered() + " voters have cast their vote";
  }
}
// LAZY: Pre-fill the text box with my own addresses.
for(var i=0; i<web3.eth.accounts.length; i++) {
   document.getElementById('addresses').value = document.getElementById('addresses').value + web3.eth.accounts[i] + ",";
}
setInterval("currentState()", 10000);
currentState();

</script>
