
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Open Vote Network on Ethereum">
    <meta name="author" content="Paddy">
    <title>Admin Page</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

    <link href="css/jquery.datetimepicker.css" rel="stylesheet">

  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Open Vote Network</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="vote.html">Vote</a></li>
            <li class="active"><a href="admin.html">Admin</a></li>
            <li><a href="livefeed.html" target="_blank">Live Feed</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <div class="jumbotron">
        <h2>Current Phase:</h2>
        <p id="state"></p>
        <h2>Question:</h2>
        <p id="question"></p>

        <div id="reset">
          <h4>Kill Switch - Reset Election</h4>
          <button onclick="reset()">Reset</button>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="thumbnail">
            <h4> 1. Unlock your Ethereum address </h4>
            <div id="dropdown">
            </div>
        </div>
        </div>
        <div class="col-md-4">
          <div class="thumbnail">
            <h4>2. List which addresses are eligible for election.</h4>
          <div id="eligible">
            <p>p.s. seperate addresses by a comma ","</p>
            <textarea id="addresses" name="list" cols="40" rows="5"></textarea> <br>
            <button onclick="setEligible()">Set as eligible</button>
          </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="thumbnail">
            <h4>3. Begin Registration Phase</h4>
            <div id="beginRegistration">
              <p id="datepairExample">
                  When should the Registration phase finish?
                  <input id="datetimepicker" type="text">
              </p>
              <p>What is the question? <input type='text' id='questioninput' value='Dummy Question?'/> </p>
              <p id="beginRegistrationbutton"><button onclick="beginRegistration()">Begin Registration Phase</button></p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <div class="thumbnail">
            <h4>4. Finish Registration Phase</h4>
            <div id="finishRegistration">
                  <p id="currentRegistration"></p>
                  <p id="finishby"></p>
                  <button onclick="finishRegistration()">Finish Registration Phase</button>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="thumbnail">
            <h4>5. Compute all special keys?</h4>
            <div id="computekeys">
              <button onclick="computekeys()">Compute Keys</button>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="thumbnail">
            <h4>6. Compute Tally</h4>
            <div id="tally">
              <button onclick="tally()">Get Tally</button>
            </div>
          </div>
        </div>
      </div>

    </div>
    <hr>

      <div id="txlist">
        <p>Transaction List:</p>
      </div>
      <div id="infodiv">
        <p>Events from Ethereum:</p>
      </div>
    </div><!-- /.container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="web3.min.js"></script>
    <script src="bignumber.min.js"></script>
    <script src="js/jquery.datetimepicker.js"></script>

<script>

// Sort out datetime picker first
jQuery('#datetimepicker').datetimepicker();
$.datetimepicker.setLocale('en');

// Relevant code that talks to Ethereum
var web3;
var password = "ilikelittlepaddy";
var addressChosen = false;
var addr = 0;
var state = 0;
var accountindex = 0;

if (typeof web3 !== 'undefined') {
  web3 = new Web3(web3.currentProvider);
} else {
  // set the provider you want from Web3.providers
  web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
}

var abi = [{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"eligible","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"xG","type":"uint256[2]"},{"name":"vG","type":"uint256[3]"},{"name":"r","type":"uint256"}],"name":"register","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[],"name":"computeTally","outputs":[{"name":"","type":"uint256[2]"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"addressid","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"w","type":"uint256"},{"name":"r1","type":"uint256"},{"name":"d1","type":"uint256"},{"name":"x","type":"uint256"}],"name":"create1outof2ZKPYesVote","outputs":[{"name":"res","type":"uint256[10]"},{"name":"res2","type":"uint256[4]"}],"type":"function"},{"constant":false,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"uint256"}],"name":"submod","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"question","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address[]"}],"name":"setEligible","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"counter","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"finishRegistrationPhase","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"params","type":"uint256[4]"},{"name":"y","type":"uint256[2]"},{"name":"a1","type":"uint256[2]"},{"name":"b1","type":"uint256[2]"},{"name":"a2","type":"uint256[2]"},{"name":"b2","type":"uint256[2]"}],"name":"submitVote","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"w","type":"uint256"},{"name":"r2","type":"uint256"},{"name":"d2","type":"uint256"},{"name":"x","type":"uint256"}],"name":"create1outof2ZKPNoVote","outputs":[{"name":"res","type":"uint256[10]"},{"name":"res2","type":"uint256[4]"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"votecast","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"params","type":"uint256[4]"},{"name":"y","type":"uint256[2]"},{"name":"a1","type":"uint256[2]"},{"name":"b1","type":"uint256[2]"},{"name":"a2","type":"uint256[2]"},{"name":"b2","type":"uint256[2]"}],"name":"verify1outof2ZKP","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"timer","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"x","type":"uint256"},{"name":"v","type":"uint256"},{"name":"xG","type":"uint256[2]"}],"name":"createZKP","outputs":[{"name":"res","type":"uint256[4]"}],"type":"function"},{"constant":false,"inputs":[],"name":"computeReconstructedPublicKeys","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"registered","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"state","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":false,"inputs":[{"name":"time","type":"uint256"},{"name":"_question","type":"string"}],"name":"beginSignUp","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"finaltally","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"reset","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"addresses","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"xG","type":"uint256[2]"},{"name":"r","type":"uint256"},{"name":"vG","type":"uint256[3]"}],"name":"verifyZKP","outputs":[{"name":"","type":"bool"}],"type":"function"},{"inputs":[],"type":"constructor"}];
var anonymousvoting = web3.eth.contract(abi);
var anonymousvotingAddr = anonymousvoting.at("0xa5a11cca1b0740a0b0221c7e059355ea572abb74");

var selectbox = "<p>Address:</p><select id='addrs'>";

var foundOwner = false;
// Let user select one of their Ethereum addresses
for(var i=0; i<web3.eth.accounts.length; i++) {

  if(anonymousvotingAddr.owner() == web3.eth.accounts[i]) {
    foundOwner = true;
    selectbox = selectbox + '<option value="' + i + '">' + web3.eth.accounts[i] + '</option>';
  }
}

selectbox = selectbox + "</select> <p>Password:</p> <input type='text' id='passwordf' value='ilikelittlepaddy' name='fname'><button onclick='unlock()'>Unlock</button>";

if(foundOwner) {
  document.getElementById('dropdown').innerHTML = selectbox;
} else {
  document.getElementById('dropdown').innerHTML = "You do not have an Ethereum account that is the Election Authority for this vote.";
}

function unlock() {
  var _addr = $('#addrs').find(":selected").text();
  var _password = document.getElementById('passwordf').value;

  if(web3.personal.unlockAccount(_addr,_password)) {
    addressChosen = true;
    addr = _addr;
    password = _password;
    accountindex = $( "#addrs" ).val();
    document.getElementById('dropdown').innerHTML = "You have selected the address " + addr;
  }
}
// Check that the user is eligible to vote
function setEligible() {
  var tempaddr;

  if(addressChosen) {

    var lastchar = document.getElementById('addresses').value.trim().slice(-1);
    var toSplit;

    // Make sure the user has not ended the list with ','
    if(lastchar == ',') {
      var len = document.getElementById('addresses').value.length;
      toSplit = document.getElementById('addresses').value.substring(0,len-1);

    } else {
      toSplit = document.getElementById('addresses').value;
    }

    var split = toSplit.split(",");

    // TODO: Sanity check the list ... verify they are all valid Ethereum addresses
    var addresses = new Array();

    // No point re-submiting an address if it is already eligible
    for(var i=0; i<split.length; i++) {
      if(!anonymousvotingAddr.eligible(split[i])) {
        addresses.push(split[i]);
      }
    }

    // Do we have any addresses that are not yet eligible?
    if(addresses.length > 0) {
      web3.personal.unlockAccount(addr,password)
      var res = anonymousvotingAddr.setEligible.sendTransaction(addresses, {from:web3.eth.accounts[accountindex], gas: 4200000})

      txlist("Set Eligible: " + res);

      alert("Sent " + addresses.length + " addresses to Ethereum whitelist");
    } else {
      alert("All addresses are already eligible!");
    }

  } else {
    alert("You need to select the admin address first!");
  }
}

// Try and fetch the re-computed key... required for tallying
function checkForReconstructedKey() {

  if(anonymousvotingAddr.reconstructed(addr) != 0) {
      computedKey = true;
      document.getElementById('reconstructed').innerHTML = "Reconstructed key found";
      index = anonymousvotingAddr.addressid(addr); // What is our index for the vote?

  } else {
      document.getElementById('foundreconstructedkey').innerHTML = "Reconstructed key NOT found";
  }
}

// Allow people to start submiting their voting key.
function beginRegistration() {

  if(!addressChosen) {
    alert("Please unlock your Ethereum address.");
    return;
  }

  if(state != 0) {
    alert("Please wait until SETUP Phase");
    return;
  }

  var d = $('#datetimepicker').datetimepicker('getValue');
  if(d == null) {
    alert("Please select the finish time for the Registration phase");
    return;
  }

  var timer = Math.floor(d.getTime()/1000); // Ethereum works in seconds, not milliseconds.
  var question = document.getElementById('questioninput').value;

  web3.personal.unlockAccount(addr,password);
  var res = anonymousvotingAddr.beginSignUp.sendTransaction(timer, question, {from:web3.eth.accounts[accountindex], gas: 4200000});
  $('#datetimepicker').datetimepicker('destroy');
  document.getElementById("beginRegistrationbutton").innerHTML  = "Waiting for Ethereum to confirm that Registration has started.";

  txlist("Begin Registration Phase: " + res);

}

function finishRegistration() {
  if(!addressChosen) {
    alert("Please unlock your Ethereum address.");
    return;
  }

  if(state != 1) {
    alert("Please wait until Registration Phase");
    return;
  }

  web3.personal.unlockAccount(addr,password);
  var res = anonymousvotingAddr.finishRegistrationPhase.sendTransaction({from:web3.eth.accounts[accountindex], gas: 4200000});
  document.getElementById("finishRegistration").innerHTML  = "Waiting for Ethereum to confirm that Registration has finished.";

  txlist("Finish Registration Phase: " + res);
}

// Tell inform to compute each voter's special key
function computekeys() {

    if(!addressChosen) {
      alert("Please unlock your Ethereum address.");
      return;
    }

    if(state != 2) {
      alert("Please wait until COMPUTE Phase");
      return;
    }

    web3.personal.unlockAccount(web3.eth.accounts[accountindex],password);
    var res = anonymousvotingAddr.computeReconstructedPublicKeys.sendTransaction({from:web3.eth.accounts[accountindex], gas: 4200000});
    document.getElementById("computekeys").innerHTML = "Waiting for Ethereum to confirm that special keys have been computed.";
    txlist("Computing Keys: " + res);

}

// Tell Ethereum to compute Tally
function tally() {

  if(!addressChosen) {
    alert("Please unlock your Ethereum address.");
    return;
  }

  if(state != 3) {
    alert("Please wait until VOTE Phase");
    return;
  }

  //TODO: Check that all votes have been cast..
  // Can do this by checking the public 'votecast' mapping...
  web3.personal.unlockAccount(web3.eth.accounts[accountindex],password);
  var res = anonymousvotingAddr.computeTally.sendTransaction({from:web3.eth.accounts[accountindex], gas: 4200000});
  document.getElementById("tally").innerHTML  = "Waiting for Ethereum to confirm tally.";
  txlist("Compute Tally: " + res);
}

function reset() {
  web3.personal.unlockAccount(web3.eth.accounts[accountindex],password);
  var res = anonymousvotingAddr.reset.sendTransaction({from:web3.eth.accounts[accountindex], gas: 4200000});
    txlist("Reset: " + res);
}

// Update question set for vote.
function whatIsQuestion() {
  var q = anonymousvotingAddr.question();
  document.getElementById('question').innerHTML = q;
}


/*
 * Catch events in real-time and update the site with the voting progress..
 */
var allevents = anonymousvotingAddr.allEvents({}, '', function(error, result){
  if (!error){

    // Tell the admin if the address became eligible...
    if(result.event === "Eligible") {
       var receipt = web3.eth.getTransactionReceipt(result.transactionHash);
       append(result.event + "," + result.args.addr);
       currentState();
    }

    // Voting phase has begun!
    if(result.event === "StartTimer") {
       var date = new Date();
       date.setTime(result.args.timestamp.toNumber() * 1000); // Ethereum is seconds. JS is milliseconds.
       append(result.event + "," + result.args.message + "," + date);
       currentState();
    }

    // Registration Phase has Finished!
    if(result.event === "RegistrationFinished") {
       append(result.event);
       currentState();
    }

    if(result.event === "Registered") {
       append(result.event + "," + result.args.addr + "," + result.args.res + ","  + result.args.counter);
    }

    if(result.event === "RegisterVote") {
      append(result.event + "," + result.args.addr + "," + result.args.res + "," + result.args.counter);
    }

    // Compute the reconstructed keys
    if(result.event === "ReconstructedKey") {
       var receipt = web3.eth.getTransactionReceipt(result.transactionHash);
       append(result.event + "," + result.args.x.toString(10) + "," + result.args.y.toString(10) + "," + result.args.counter);
       currentState();
    }

    // Final tally... tell us gas usage as well.
    if(result.event === "Tally") {
      var receipt = web3.eth.getTransactionReceipt(result.transactionHash);
      append(result.event + " - Yes Votes: " + result.args.tally.toString(10) + " and Total Votes Counted: " + result.args.counter.toString(10));
    }

    if(result.event === "Debug") {
      append(result.event + "," + result.args.msg + "," + result.args.num);
    }
  }
});

function append(extra) {
    var div = document.getElementById('infodiv');
    div.innerHTML = div.innerHTML + "<br>" + "<p>" + extra + "</p>";
}

function txlist(extra) {
    document.getElementById('txlist').innerHTML = document.getElementById('txlist').innerHTML + "<br>" + extra;
}

function currentState() {
  state = anonymousvotingAddr.state();
  whatIsQuestion();

  if(state == 0) {
    document.getElementById('state').innerHTML = "SETUP: You need to whitelist each voter's address";
  } else if(state == 1) {
    document.getElementById('state').innerHTML = "SIGNUP: Voters need to register their voting codes.";
    document.getElementById("eligible").innerHTML = "Can no longer Registration new addresses";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";
    $('#datetimepicker').datetimepicker('destroy');
    var finishby = document.getElementById('finishby');
    if(finishby != null) {
      var date = new Date();
      date.setTime(anonymousvotingAddr.timer() * 1000);
      document.getElementById('finishby').innerHTML = "You can finish the Registration phase after  " + date;
      var c = anonymousvotingAddr.counter();
      document.getElementById('currentRegistration').innerHTML = "Currently have " + c + " voters signed up.";
    }
  } else if(state == 2) {
    document.getElementById('state').innerHTML = "COMPUTE: You need to inform Ethereum to compute the voter's special keys";
    document.getElementById("eligible").innerHTML = "Can no longer Registration new addresses";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";
    document.getElementById('finishRegistration').innerHTML = "Registration phase has already finshed";
    $('#datetimepicker').datetimepicker('destroy');
  } else if(state == 3) {
    document.getElementById('state').innerHTML = "VOTE: Voters need to cast their vote. ";
    document.getElementById("eligible").innerHTML = "Can no longer Registration new addresses";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";
    document.getElementById('finishRegistration').innerHTML = "Registration phase has already finshed";
    document.getElementById('computekeys').innerHTML = "Voters keys have already been computed";
    $('#datetimepicker').datetimepicker('destroy');
  } else if(state == 4) {
    var yes = anonymousvotingAddr.finaltally(0);
    var total = anonymousvotingAddr.finaltally(1);
    var no = total - yes;
    document.getElementById('state').innerHTML = "TALLY: Yes - " + yes + " No - " + no;
    document.getElementById("eligible").innerHTML = "Can no longer Registration new addresses";
    document.getElementById('beginRegistration').innerHTML = "Can no longer set question of vote";
    document.getElementById('finishRegistration').innerHTML = "Registration phase has already finshed";
    document.getElementById('computekeys').innerHTML = "Voters keys have already been computed";
    document.getElementById('tally').innerHTML = "Tally has been computed!";
    $('#datetimepicker').datetimepicker('destroy');
  } else {
    document.getElementById('state').innerHTML = "Undocumented Phase...";
  }
}

// LAZY: Pre-fill the text box with my own addresses.
for(var i=0; i<web3.eth.accounts.length; i++) {
   document.getElementById('addresses').value = document.getElementById('addresses').value + web3.eth.accounts[i] + ",";
}
setInterval("currentState()", 1000);
currentState();

</script>
