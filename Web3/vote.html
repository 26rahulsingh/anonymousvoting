<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Open Vote Network on Ethereum">
    <meta name="author" content="Paddy">
    <title>Voting Page</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Open Vote Network </a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Vote</a></li>
            <li><a href="admin.html">Admin</a></li>
            <li><a href="livefeed.html" target="_blank">Live Feed</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <div class="jumbotron">
        <h2>Current Phase:</h2>
        <p id="state"></p>
        <h2>Question:</h2>
        <p id="question"></p>
        <div id="vote">
        <button onclick="vote(1)">Yes</button>
        <button onclick="vote(0)">No</button>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="thumbnail">
          <h4> 1. Upload Voting Codes </h4>
          <div id="upload">
             <p>Please open the file with your voting codes</p>
             <input type='file' accept='text/plain' onchange='openFile(event)'>
          </div>
        </div>
        </div>
        <div class="col-md-4">
          <div class="thumbnail">
          <h4> 2. Unlock your Ethereum address </h4>
          <div id="dropdown">
          </div>
          <div id="eligible">
          <p>Is the currently selected address eligible to vote? </p>
          <button onclick="eligible()">Eligible</button>
          <p id="iseligible"></p>
          </div>
        </div>
        </div>
        <div class="col-md-4">
          <div class="thumbnail">
          <h4> 3. Register for vote</h4>
          <div id="submitvotingkey">
          <p>This will send a voting code to Ethereum.</p>
          <p id="registerby"></p>
          <button onclick="register()">Register</button>
          </div>
        </div>
        </div>
      </div>

      <hr>

      <div id="txlist">
        <p>Transaction List:</p>
      </div>
      <div id="infodiv">
        <p>Events from Ethereum:</p>
      </div>
    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="web3.min.js"></script>
    <script src="bignumber.min.js"></script>

    <script>

    var web3;
    var password = "ilikelittlepaddy";
    var accounts_index;
    if (typeof web3 !== 'undefined') {
      web3 = new Web3(web3.currentProvider);
    } else {
      // set the provider you want from Web3.providers
      web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
    }

    var abi = [{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"eligible","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"xG","type":"uint256[2]"},{"name":"vG","type":"uint256[3]"},{"name":"r","type":"uint256"}],"name":"register","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[],"name":"computeTally","outputs":[{"name":"","type":"uint256[2]"}],"type":"function"},{"constant":true,"inputs":[],"name":"round","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"addressid","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"w","type":"uint256"},{"name":"r1","type":"uint256"},{"name":"d1","type":"uint256"},{"name":"x","type":"uint256"}],"name":"create1outof2ZKPYesVote","outputs":[{"name":"res","type":"uint256[10]"},{"name":"res2","type":"uint256[4]"}],"type":"function"},{"constant":false,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"uint256"}],"name":"submod","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"question","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address[]"}],"name":"setEligible","outputs":[],"type":"function"},{"constant":true,"inputs":[],"name":"counter","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"finishRegistrationPhase","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"params","type":"uint256[4]"},{"name":"y","type":"uint256[2]"},{"name":"a1","type":"uint256[2]"},{"name":"b1","type":"uint256[2]"},{"name":"a2","type":"uint256[2]"},{"name":"b2","type":"uint256[2]"}],"name":"submitVote","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"w","type":"uint256"},{"name":"r2","type":"uint256"},{"name":"d2","type":"uint256"},{"name":"x","type":"uint256"}],"name":"create1outof2ZKPNoVote","outputs":[{"name":"res","type":"uint256[10]"},{"name":"res2","type":"uint256[4]"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"votecast","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"params","type":"uint256[4]"},{"name":"y","type":"uint256[2]"},{"name":"a1","type":"uint256[2]"},{"name":"b1","type":"uint256[2]"},{"name":"a2","type":"uint256[2]"},{"name":"b2","type":"uint256[2]"}],"name":"verify1outof2ZKP","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"timer","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"x","type":"uint256"},{"name":"v","type":"uint256"},{"name":"xG","type":"uint256[2]"}],"name":"createZKP","outputs":[{"name":"res","type":"uint256[4]"}],"type":"function"},{"constant":false,"inputs":[],"name":"computeReconstructedPublicKeys","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"registered","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[],"name":"state","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":false,"inputs":[{"name":"time","type":"uint256"},{"name":"_question","type":"string"}],"name":"beginSignUp","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"finaltally","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"reset","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"addresses","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"xG","type":"uint256[2]"},{"name":"r","type":"uint256"},{"name":"vG","type":"uint256[3]"}],"name":"verifyZKP","outputs":[{"name":"","type":"bool"}],"type":"function"},{"inputs":[],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"address"}],"name":"Eligible","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"message","type":"string"},{"indexed":false,"name":"timestamp","type":"uint256"},{"indexed":false,"name":"current_timestamp","type":"uint256"}],"name":"StartTimer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"address"},{"indexed":false,"name":"res","type":"bool"},{"indexed":false,"name":"counter","type":"uint256"}],"name":"Registered","type":"event"},{"anonymous":false,"inputs":[],"name":"RegistrationFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"x","type":"uint256"},{"indexed":false,"name":"y","type":"uint256"},{"indexed":false,"name":"counter","type":"uint256"}],"name":"ReconstructedKey","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"address"},{"indexed":false,"name":"res","type":"bool"},{"indexed":false,"name":"counter","type":"uint256"}],"name":"RegisterVote","type":"event"}];
    var anonymousvoting = web3.eth.contract(abi);
    var anonymousvotingAddr = anonymousvoting.at("0x194796d4428cf2022a455d68e40cbcc4c2148afa");
    var selectbox = "<p>Address:</p><select id='addrs'>";

    // Let user select one of their Ethereum addresses
    for(var i=0; i<web3.eth.accounts.length; i++) {
      selectbox = selectbox + '<option value="' + i + '">' + web3.eth.accounts[i] + '</option>';
    }

    selectbox = selectbox + "</select> <p>Password:</p> <input type='password' id='passwordf' value='ilikelittlepaddy' name='fname'><button onclick='unlock()'>Unlock</button>";
    document.getElementById('dropdown').innerHTML = selectbox;

    function unlock() {
      var _addr = $('#addrs').find(":selected").text();
      var _password = document.getElementById('passwordf').value;

      if(web3.personal.unlockAccount(_addr,_password)) {
        addressChosen = true;
        addr = _addr;
        password = _password;
        accounts_index = $( "#addrs" ).val();
        document.getElementById('dropdown').innerHTML = "You have selected the address " + addr;
      }

      currentState();
    }

    // Check that the user is eligible to vote
    function eligible() {
      var tempaddr;

      // User might not have chosen their address yet...
      if(addressChosen) {
        tempaddr = addr;
      } else {
        tempaddr = $('#addrs').find(":selected").text();
      }

      if(anonymousvotingAddr.eligible(tempaddr)) {
        document.getElementById('iseligible').innerHTML = "Yes! This address is eligible to vote!";
      } else {
        alert("You are not yet eligible");
      }
    }

    // Vote submits their voting key.
    function register() {

      if(!uploaded) {
        alert("Please upload your voting codes.");
        return;
      }

      if(!addressChosen) {
        alert("Please unlock your Ethereum address.");
        return;
      }

      if(state != 1) {
        alert("You can only register during the SIGNUP Phase. ");
        return;
      }

      // We prove knowledge of the voting key
      var zkp = anonymousvotingAddr.createZKP.call(x, v, xG, {from:web3.eth.accounts[accounts_index]});
      var vG = [zkp[1], zkp[2], zkp[3]];
      web3.personal.unlockAccount(addr,password);

      // Submit voting key to the network

      if(anonymousvotingAddr.register.call(xG, vG, zkp[0], {from:web3.eth.accounts[accounts_index]})) {
        var res = anonymousvotingAddr.register.sendTransaction(xG, vG, zkp[0], {from:web3.eth.accounts[accounts_index], gas: 4200000});
        document.getElementById('submitvotingkey').innerHTML = "Voting key submitted. Waiting on Ethereum to confirm.";
        txlist("Submit voting key: " + res);
      } else {
        alert("Registration failed. Problem could be your voting codes or that you have already registered.");
      }


    }


    // User votes yes or no!
    function vote(choice) {

      if(!uploaded) {
        alert("Please upload your voting codes.");
        return;
      }

      if(!addressChosen) {
        alert("Please unlock your Ethereum address.");
        return;
      }

      if(state != 3) {
        alert("You can vote during the VOTE phase.");
        return;
      }

      // Lets make sure they are registered too...
      if(!anonymousvotingAddr.registered(addr)) {
        alert("You are not registered for this vote.");
        return;
      }

      var ind = anonymousvotingAddr.addressid(addr); // What is our index for the vote?

      // Create vote...
      var choice_text;
      if(choice == 1) {
        choice_text = "YES";
        result = anonymousvotingAddr.create1outof2ZKPYesVote.call(w,r,d,x, {from:web3.eth.accounts[accounts_index]});
      } else {
        choice_text = "NO";
        result = anonymousvotingAddr.create1outof2ZKPNoVote.call(w,r,d,x, {from:web3.eth.accounts[accounts_index]});
      }

      var y = [result[0][0], result[0][1]];
      var a1 = [result[0][2], result[0][3]];
      var b1 = [result[0][4], result[0][5]];
      var a2 = [result[0][6], result[0][7]];
      var b2 = [result[0][8], result[0][9]];

      var params = [result[1][0], result[1][1], result[1][2], result[1][3]];
      result = anonymousvotingAddr.verify1outof2ZKP.call(params, y, a1, b1, a2, b2, {from:web3.eth.accounts[accounts_index]});
      // alert("Does the 1 out of 2 ZKP Verify: "  + result);


      if(result) {

        if(confirm("You are voting " + choice_text + ". Please confirm this choice.")) {
          web3.personal.unlockAccount(addr,password);
          result = anonymousvotingAddr.submitVote.sendTransaction(params, y, a1, b1, a2, b2, {from:web3.eth.accounts[accounts_index], gas: 4200000});
          document.getElementById('vote').innerHTML = 'Vote has been submitted. Waiting for confirmation.';
          txlist("Submit vote: " + result);
        }
      } else {
        alert("Vote was not computed successfully. Please check that you have uploaded the correct voting codes and unlocked the correct account.");
      }
    }

    function whatIsQuestion() {
      document.getElementById('question').innerHTML = anonymousvotingAddr.question();
    }

    whatIsQuestion();

    //[0] = x (private key)
    //[1] = xG (public key)
    //[2] = v (random nonce for zkp)
    //[3] = w (random nonce for 1outof2 zkp)
    //[4] = r (1 or 2, random nonce for 1outof2 zkp)
    //[5] = d (1 or 2, random nonce for 1outof2 zkp)
    // Read file that contains users drawOperationGasTable

    // x & xG is the voting key
    // v is the blinding factor for single zkp
    // w,r,d is required for 1 out of 2 zkp.
    // yG is recomputed public key - we get this from Ethereum
    var x;
    var xG;
    var v;
    var w;
    var r;
    var d;
    var addr;

    // Keep track of what user has done...
    var addressChosen = false;
    var uploaded = false;
    var computedKey = false;

    var openFile = function(event) {
      var input = event.target;

      var reader = new FileReader();
      reader.onload = function(){
        var text = reader.result.split("\n");

        var row = text[0].split(",");

        // We are expecting 7 numbers...
        if(row.length == 7) {
           uploaded = true;
           x = new BigNumber(row[0]);
           xG = [new BigNumber(row[1]), new BigNumber(row[2])];
           v = new BigNumber(row[3]);
           w = new BigNumber(row[4]);
           r = new BigNumber(row[5]);
           d = new BigNumber(row[6]);
          //  alert("Upload Succesful!");
           document.getElementById('upload').innerHTML = "We have extracted your voting codes.";

        } else {
          alert("Problem with uploaded file..." + row.length);
        }
      }

      reader.readAsText(input.files[0]);
    };

    function currentState() {
      state = anonymousvotingAddr.state();

      if(state == 0) {
        document.getElementById('state').innerHTML = "SETUP: Election Authority is organising the election. ";
      } else if(state == 1) {
        document.getElementById('state').innerHTML = "SIGNUP: You can now sign up to the election if you are eligible. ";
        var registerby = document.getElementById('registerby');

        if(registerby != null) {
          var date = new Date();
          date.setTime(anonymousvotingAddr.timer() * 1000);
          document.getElementById('registerby').innerHTML = "Please register by " + date;
        }
      } else if(state == 2) {
        document.getElementById('state').innerHTML = "COMPUTE: Ethereum is about to compute all voters special keys. ";
      } else if(state == 3) {
        document.getElementById('state').innerHTML = "VOTE: You can now cast your vote. ";
      } else if(state == 4) {
        var yes = anonymousvotingAddr.finaltally(0);
        var total = anonymousvotingAddr.finaltally(1);
        var no = total - yes;
        document.getElementById('state').innerHTML = "TALLY: Yes - " + yes + " No - " + no;
      } else {
        document.getElementById('state').innerHTML = "Undocumented Phase: Something went wrong. ";
      }

      // Are we eligible to vote?
      if(anonymousvotingAddr.eligible(addr)) {
        document.getElementById('eligible').innerHTML = "You are eligible to vote";
      }
      // Check if key has been submitted
      if(anonymousvotingAddr.registered(addr)) {
         document.getElementById('submitvotingkey').innerHTML = "Voting key has been accepted by Ethereum";

         //Check if vote has already been cast
         if(anonymousvotingAddr.votecast(addr)) {
           document.getElementById('vote').innerHTML = "Vote has been cast.";
         }
      }

      whatIsQuestion();

    }

    /*
    * Catch events in real-time and update the site with the voting progress..
    */
    var allevents = anonymousvotingAddr.allEvents({}, '', function(error, result){
     if (!error){

       // Tell the admin if the address became eligible...
       if(result.event === "Eligible") {
          var receipt = web3.eth.getTransactionReceipt(result.transactionHash);

          if(result.args.addr == addr) {
            append(result.event + "," + result.args.addr);
          }
       }

       // Voting phase has begun!
       if(result.event === "StartTimer") {
         var date = new Date();
         date.setTime(result.args.timestamp.toNumber() * 1000); // Ethereum is seconds. JS is milliseconds.
         append(result.event + "," + result.args.message + "," + date);
       }

       // Voting key has been submitted.
       if(result.event === "Registered") {
         if(result.args.addr == addr) {
           append(result.event + "," + result.args.addr + "," + result.args.res + "," + result.args.counter);
         }
       }

       // Registration Phase has Finished!
       if(result.event === "RegistrationFinished") {
          append(result.event);
       }

       // Compute the reconstructed keys
       if(result.event === "ReconstructedKey") {
          if(anonymousvotingAddr.addressid(addr).equals(result.args.counter)) {
            append(result.event + "," + result.args.x.toString(10) + "," + result.args.y.toString(10) + "," + result.args.counter);
          }
       }

       // Vote has been cast.
       if(result.event === "RegisterVote") {
         if(result.args.addr == addr) {
           append(result.event + "," + result.args.addr + "," + result.args.res + "," + result.args.counter);
         }
       }

       // Final tally... tell us gas usage as well.
       if(result.event === "Tally") {
         append(result.event + " - Yes Votes: " + result.args.tally.toString(10) + " and Total Votes Counted: " + result.args.counter.toString(10));
       }

       // Always update current state.
       currentState();
     }
    });

    function append(extra) {
        var div = document.getElementById('infodiv');
        div.innerHTML = div.innerHTML + "<br>" + "<p>" + extra + "</p>";
    }

    function txlist(extra) {
        document.getElementById('txlist').innerHTML = document.getElementById('txlist').innerHTML + "<br>" + extra;
    }

    setInterval("currentState()", 1000);
    currentState();
  </script>
  </body>
</html>
